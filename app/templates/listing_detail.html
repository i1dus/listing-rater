{% extends "base.html" %}

{% block title %}Объявление - Listing Rater{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/listings" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i> Назад к списку
    </a>
</div>

<div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Загрузка...</p>
</div>

<div id="content" style="display: none;">
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="listing-title">-</span>
                    <span id="listing-status"></span>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 id="listing-price" class="text-primary mb-3">-</h4>
                            <p class="mb-1"><strong>ID Циан:</strong> <a id="avito-link" href="#" target="_blank">-</a></p>
                            <p class="mb-1"><strong>Адрес:</strong> <span id="listing-address">-</span></p>
                            <p class="mb-1"><strong>Метро:</strong> <span id="listing-metro">-</span></p>
                            <p class="mb-1"><strong>Тип сделки:</strong> <span id="listing-deal-type">-</span></p>
                            <p class="mb-1"><strong>Тип недвижимости:</strong> <span id="listing-property-type">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Комнат:</strong> <span id="listing-rooms">-</span></p>
                            <p class="mb-1"><strong>Площадь общая:</strong> <span id="listing-area-total">-</span></p>
                            <p class="mb-1"><strong>Площадь жилая:</strong> <span id="listing-area-living">-</span></p>
                            <p class="mb-1"><strong>Площадь кухни:</strong> <span id="listing-area-kitchen">-</span></p>
                            <p class="mb-1"><strong>Этаж:</strong> <span id="listing-floor">-</span></p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Описание</h6>
                    <p id="listing-description" class="text-muted" style="white-space: pre-wrap;">-</p>
                </div>
            </div>
            
            <!-- История статусов -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history me-2"></i> История статусов
                </div>
                <div class="card-body">
                    <div id="status-logs">
                        <p class="text-muted">Нет данных</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Связанный объект -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-building me-2"></i> Объект недвижимости
                </div>
                <div class="card-body" id="property-info">
                    <p class="text-muted">Не привязан</p>
                </div>
            </div>
            
            <!-- Детали метчинга -->
            <div class="card mb-4" id="match-details-card" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-diagram-3 me-2"></i> Детали метчинга
                </div>
                <div class="card-body" id="match-details-content">
                    <!-- Детали будут загружены динамически -->
                </div>
            </div>
            
            <!-- Парсинг -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-download me-2"></i> Парсинг
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary w-100 mb-2" id="parse-details-btn">
                        <i class="bi bi-arrow-repeat me-2"></i> Спарсить полностью
                    </button>
                    <small class="text-muted">Загрузит все данные с детальной страницы объявления</small>
                    <div id="parse-status" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Вероятность продажи -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i> Вероятность продажи
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-success w-100 mb-2" id="calculate-probability-btn" style="display: none;">
                        <i class="bi bi-calculator me-2"></i> Вычислить вероятность продажи
                    </button>
                    <small class="text-muted d-block mb-2">Сначала выполните "Спарсить полностью"</small>
                    <div id="probability-result"></div>
                </div>
            </div>
            
            <!-- Редактирование -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-pencil me-2"></i> Редактирование
                </div>
                <div class="card-body">
                    <form id="edit-form">
                        <div class="mb-3">
                            <label class="form-label">Цена</label>
                            <input type="number" class="form-control" id="edit-price">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Комнат</label>
                            <input type="number" class="form-control" id="edit-rooms">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Площадь</label>
                            <input type="number" step="0.1" class="form-control" id="edit-area">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="edit-status">
                                <option value="true">Активно</option>
                                <option value="false">Неактивно</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-lg me-2"></i> Сохранить
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const listingId = {{ listing_id }};
    let listingData = null;
    
    async function loadListing() {
        try {
            const response = await fetch(`/api/listings/${listingId}`);
            if (!response.ok) {
                throw new Error('Listing not found');
            }
            
            listingData = await response.json();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // Заполняем данные
            document.getElementById('listing-title').textContent = listingData.title || 'Без заголовка';
            document.getElementById('listing-status').innerHTML = listingData.is_active 
                ? '<span class="badge badge-active">Активно</span>'
                : '<span class="badge badge-inactive">Снято</span>';
            
            const price = listingData.price 
                ? new Intl.NumberFormat('ru-RU').format(listingData.price) + ' ₽'
                : '-';
            document.getElementById('listing-price').textContent = price;
            
            document.getElementById('avito-link').textContent = listingData.avito_id;
            document.getElementById('avito-link').href = listingData.url;
            
            document.getElementById('listing-address').textContent = 
                [listingData.city, listingData.district, listingData.address].filter(Boolean).join(', ') || '-';
            
            // Метро
            let metroText = '-';
            if (listingData.metro) {
                metroText = listingData.metro;
                if (listingData.metro_time) {
                    const transport = listingData.metro_transport === 'walk' ? 'пешком' : 'на транспорте';
                    metroText += ` (${listingData.metro_time} мин ${transport})`;
                }
            }
            document.getElementById('listing-metro').textContent = metroText;
            
            // Отображаем тип сделки (может быть уже на русском или транслит)
            const dealTypeDisplay = listingData.deal_type === 'Продажа' || listingData.deal_type === 'prodam' || listingData.deal_type === 'sale' 
                ? 'Продажа' 
                : (listingData.deal_type === 'Аренда' || listingData.deal_type === 'sdam' || listingData.deal_type === 'rent' 
                    ? 'Аренда' 
                    : listingData.deal_type || '-');
            document.getElementById('listing-deal-type').textContent = dealTypeDisplay;
            document.getElementById('listing-property-type').textContent = listingData.property_type || '-';
            
            document.getElementById('listing-rooms').textContent = listingData.rooms !== null ? listingData.rooms : '-';
            document.getElementById('listing-area-total').textContent = listingData.area_total ? listingData.area_total + ' м²' : '-';
            document.getElementById('listing-area-living').textContent = listingData.area_living ? listingData.area_living + ' м²' : '-';
            document.getElementById('listing-area-kitchen').textContent = listingData.area_kitchen ? listingData.area_kitchen + ' м²' : '-';
            document.getElementById('listing-floor').textContent = 
                listingData.floor ? `${listingData.floor}/${listingData.floors_total || '?'}` : '-';
            
            document.getElementById('listing-description').textContent = listingData.description || 'Описание отсутствует';
            
            // Форма редактирования
            document.getElementById('edit-price').value = listingData.price || '';
            document.getElementById('edit-rooms').value = listingData.rooms !== null ? listingData.rooms : '';
            document.getElementById('edit-area').value = listingData.area_total || '';
            document.getElementById('edit-status').value = listingData.is_active ? 'true' : 'false';
            
            // История статусов
            if (listingData.status_logs && listingData.status_logs.length > 0) {
                let logsHtml = '<ul class="list-group list-group-flush">';
                for (const log of listingData.status_logs) {
                    const statusLabels = {
                        'published': '<span class="badge bg-success">Опубликовано</span>',
                        'removed': '<span class="badge bg-danger">Снято</span>',
                        'reactivated': '<span class="badge bg-info">Восстановлено</span>'
                    };
                    const date = new Date(log.created_at).toLocaleString('ru-RU');
                    logsHtml += `
                        <li class="list-group-item d-flex justify-content-between">
                            ${statusLabels[log.status] || log.status}
                            <small class="text-muted">${date}</small>
                        </li>
                    `;
                }
                logsHtml += '</ul>';
                document.getElementById('status-logs').innerHTML = logsHtml;
            }
            
            // Объект недвижимости
            if (listingData.property_id) {
                let matchScoreHtml = '';
                if (listingData.match_score !== null && listingData.match_score !== undefined) {
                    const score = Math.round(listingData.match_score);
                    let badgeClass = 'bg-success';
                    if (score < 70) badgeClass = 'bg-danger';
                    else if (score < 85) badgeClass = 'bg-warning';
                    
                    matchScoreHtml = `
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Сходство с объектом:</small>
                            <span class="badge ${badgeClass}">${score}%</span>
                        </div>
                    `;
                }
                
                document.getElementById('property-info').innerHTML = `
                    ${matchScoreHtml}
                    <a href="/properties/${listingData.property_id}" class="btn btn-outline-primary w-100">
                        <i class="bi bi-building me-2"></i> Объект #${listingData.property_id}
                    </a>
                `;
                
                // Загружаем детали метчинга
                loadMatchDetails();
            }
            
            // Показываем кнопку вычисления вероятности если есть достаточно данных
            const hasEnoughData = listingData.price || listingData.area_total || listingData.rooms !== null;
            const probabilityBtn = document.getElementById('calculate-probability-btn');
            const probabilityHint = probabilityBtn.nextElementSibling;
            
            if (hasEnoughData) {
                probabilityBtn.style.display = 'block';
                probabilityHint.style.display = 'none';
            } else {
                probabilityBtn.style.display = 'none';
                probabilityHint.style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error loading listing:', error);
            document.getElementById('loading').innerHTML = `
                <div class="alert alert-danger">
                    Объявление не найдено
                </div>
            `;
        }
    }
    
    // Обработка кнопки парсинга
    document.getElementById('parse-details-btn').addEventListener('click', async () => {
        const btn = document.getElementById('parse-details-btn');
        const statusDiv = document.getElementById('parse-status');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Парсинг...';
        statusDiv.innerHTML = '<div class="alert alert-info mb-0">Загрузка данных...</div>';
        
        try {
            const response = await fetch(`/api/listings/${listingId}/parse-details`, {
                method: 'POST'
            });
            
            if (response.ok) {
                statusDiv.innerHTML = '<div class="alert alert-success mb-0">Данные успешно обновлены!</div>';
                // Перезагружаем объявление
                setTimeout(() => {
                    loadListing();
                    statusDiv.innerHTML = '';
                    // Показываем кнопку вычисления вероятности после парсинга
                    const probabilityBtn = document.getElementById('calculate-probability-btn');
                    const probabilityHint = probabilityBtn.nextElementSibling;
                    if (probabilityBtn) {
                        probabilityBtn.style.display = 'block';
                        if (probabilityHint) probabilityHint.style.display = 'none';
                    }
                }, 1500);
            } else {
                const error = await response.json();
                statusDiv.innerHTML = `<div class="alert alert-danger mb-0">Ошибка: ${error.detail || 'Не удалось спарсить данные'}</div>`;
            }
        } catch (error) {
            console.error('Error parsing listing:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger mb-0">Ошибка при парсинге</div>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i> Спарсить полностью';
        }
    });
    
    // Обработка кнопки вычисления вероятности
    document.getElementById('calculate-probability-btn').addEventListener('click', async () => {
        const btn = document.getElementById('calculate-probability-btn');
        const resultDiv = document.getElementById('probability-result');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Вычисление...';
        resultDiv.innerHTML = '<div class="alert alert-info mb-0">Вычисление вероятности...</div>';
        
        try {
            const response = await fetch(`/api/listings/${listingId}/sale-probability`);
            
            if (response.ok) {
                const data = await response.json();
                
                let factorsHtml = '';
                if (data.factors && data.factors.length > 0) {
                    factorsHtml = '<div class="mt-3"><small class="text-muted d-block mb-2">Факторы:</small><ul class="list-unstyled small">';
                    for (const factor of data.factors) {
                        factorsHtml += `<li>${factor}</li>`;
                    }
                    factorsHtml += '</ul></div>';
                }
                
                resultDiv.innerHTML = `
                    <div class="alert alert-${data.category_color} mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Вероятность продажи: ${data.probability}%</strong>
                            <span class="badge bg-${data.category_color}">${data.category}</span>
                        </div>
                        ${factorsHtml}
                    </div>
                `;
            } else {
                const error = await response.json();
                resultDiv.innerHTML = `<div class="alert alert-danger mb-0">Ошибка: ${error.detail || 'Не удалось вычислить вероятность'}</div>`;
            }
        } catch (error) {
            console.error('Error calculating probability:', error);
            resultDiv.innerHTML = '<div class="alert alert-danger mb-0">Ошибка при вычислении вероятности</div>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-calculator me-2"></i> Вычислить вероятность продажи';
        }
    });
    
    // Обработка формы редактирования
    document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            price: parseInt(document.getElementById('edit-price').value) || null,
            rooms: parseInt(document.getElementById('edit-rooms').value) || null,
            area_total: parseFloat(document.getElementById('edit-area').value) || null,
            is_active: document.getElementById('edit-status').value === 'true'
        };
        
        try {
            const response = await fetch(`/api/listings/${listingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Сохранено!');
                loadListing();
            }
        } catch (error) {
            console.error('Error updating listing:', error);
            alert('Ошибка сохранения');
        }
    });
    
    async function loadMatchDetails() {
        try {
            const response = await fetch(`/api/listings/${listingId}/match-details`);
            if (!response.ok) {
                return;
            }
            
            const matchData = await response.json();
            
            if (!matchData.has_match) {
                return;
            }
            
            const detailsCard = document.getElementById('match-details-card');
            const detailsContent = document.getElementById('match-details-content');
            
            let html = '';
            
            // Общий процент сходства
            const score = Math.round(matchData.similarity_score);
            let badgeClass = 'bg-success';
            if (score < matchData.threshold) badgeClass = 'bg-danger';
            else if (score < 85) badgeClass = 'bg-warning';
            
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Процент сходства:</strong>
                        <span class="badge ${badgeClass}">${score}%</span>
                    </div>
                    <small class="text-muted">Порог: ${matchData.threshold}%</small>
                </div>
            `;
            
            // Нарушения строгих атрибутов
            if (matchData.strict_violations && matchData.strict_violations.length > 0) {
                html += `
                    <div class="alert alert-danger mb-3">
                        <strong>Нарушены строгие атрибуты:</strong>
                        <ul class="mb-0 mt-2">
                            ${matchData.strict_violations.map(attr => `<li><code>${attr}</code></li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Детали по атрибутам
            html += '<h6 class="mb-3">Детали совпадения:</h6>';
            html += '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Атрибут</th><th>Объявление</th><th>Объект</th><th>Совпадение</th><th>Вес</th></tr></thead>';
            html += '<tbody>';
            
            for (const attr of matchData.matched_attributes) {
                const matchIcon = attr.matches 
                    ? '<i class="bi bi-check-circle-fill text-success"></i>' 
                    : '<i class="bi bi-x-circle-fill text-danger"></i>';
                const similarityPercent = Math.round(attr.similarity * 100);
                const strictBadge = attr.is_strict ? ' <span class="badge bg-warning">строгий</span>' : '';
                
                html += `
                    <tr class="${attr.matches ? '' : 'table-danger'}">
                        <td>
                            <strong>${attr.label}</strong>${strictBadge}
                            <br><small class="text-muted"><code>${attr.attribute}</code></small>
                        </td>
                        <td>${formatValue(attr.listing_value)}</td>
                        <td>${formatValue(attr.property_value)}</td>
                        <td>
                            ${matchIcon} ${similarityPercent}%
                        </td>
                        <td>${attr.weight.toFixed(1)}%</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table></div>';
            
            detailsContent.innerHTML = html;
            detailsCard.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading match details:', error);
        }
    }
    
    function formatValue(value) {
        if (value === null || value === undefined || value === '') {
            return '<span class="text-muted">-</span>';
        }
        if (typeof value === 'number') {
            return value;
        }
        return value;
    }
    
    document.addEventListener('DOMContentLoaded', loadListing);
</script>
{% endblock %}
