{% extends "base.html" %}

{% block title %}Дашборд - Listing Rater{% endblock %}

{% block content %}
<h1 class="mb-4">Дашборд</h1>

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-value">{{ listings_count }}</div>
                <div class="stat-label">Всего объявлений</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card success">
            <div class="card-body">
                <div class="stat-value">{{ active_listings }}</div>
                <div class="stat-label">Активных объявлений</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card warning">
            <div class="card-body">
                <div class="stat-value">{{ properties_count }}</div>
                <div class="stat-label">Объектов недвижимости</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart me-2"></i> Статистика по объявлениям
            </div>
            <div class="card-body">
                <div id="listings-stats">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Загрузка...
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-geo-alt me-2"></i> Топ городов
            </div>
            <div class="card-body">
                <div id="cities-stats">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Загрузка...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i> Последние объявления</span>
                <a href="/listings" class="btn btn-sm btn-outline-primary">Все объявления</a>
            </div>
            <div class="card-body">
                <div id="recent-listings">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Загрузка...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Загрузка статистики
    async function loadStats() {
        try {
            const response = await fetch('/api/listings/stats/summary');
            const data = await response.json();
            
            document.getElementById('listings-stats').innerHTML = `
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">${data.by_deal_type['Продажа'] || data.by_deal_type.prodam || data.by_deal_type.sale || 0}</h4>
                        <small class="text-muted">Продажа</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">${data.by_deal_type['Аренда'] || data.by_deal_type.sdam || data.by_deal_type.rent || 0}</h4>
                        <small class="text-muted">Аренда</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">${data.active}</h4>
                        <small class="text-muted">Активные</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-secondary">${data.inactive}</h4>
                        <small class="text-muted">Неактивные</small>
                    </div>
                </div>
            `;
            
            let citiesHtml = '<ul class="list-group list-group-flush">';
            for (const city of data.top_cities || []) {
                citiesHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${city.city}
                        <span class="badge bg-primary rounded-pill">${city.count}</span>
                    </li>
                `;
            }
            citiesHtml += '</ul>';
            if (!data.top_cities || data.top_cities.length === 0) {
                citiesHtml = '<p class="text-muted text-center">Нет данных</p>';
            }
            document.getElementById('cities-stats').innerHTML = citiesHtml;
            
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Загрузка последних объявлений
    async function loadRecentListings() {
        try {
            const response = await fetch('/api/listings?per_page=5');
            const data = await response.json();
            
            if (data.items.length === 0) {
                document.getElementById('recent-listings').innerHTML = `
                    <p class="text-muted text-center">Объявлений пока нет. <a href="/parser">Запустите парсинг</a></p>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>ID</th><th>Заголовок</th><th>Цена</th><th>Город</th><th>Статус</th></tr></thead><tbody>';
            
            for (const listing of data.items) {
                const status = listing.is_active 
                    ? '<span class="badge badge-active">Активно</span>' 
                    : '<span class="badge badge-inactive">Снято</span>';
                const price = listing.price ? new Intl.NumberFormat('ru-RU').format(listing.price) + ' ₽' : '-';
                
                html += `
                    <tr onclick="window.location='/listings/${listing.id}'" style="cursor:pointer">
                        <td>${listing.avito_id}</td>
                        <td>${listing.title || '-'}</td>
                        <td>${price}</td>
                        <td>${listing.city || '-'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table></div>';
            document.getElementById('recent-listings').innerHTML = html;
            
        } catch (error) {
            console.error('Error loading listings:', error);
        }
    }
    
    // Загружаем данные при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadRecentListings();
    });
</script>
{% endblock %}
