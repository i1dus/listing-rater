# Listing Rater

Система парсинга и анализа объявлений недвижимости с Cian.ru

## Описание

**Listing Rater** — это веб-приложение для автоматического сбора, анализа и управления объявлениями о недвижимости. Система парсит объявления с сайта Cian.ru, группирует их по объектам недвижимости, отслеживает изменения и предоставляет удобный веб-интерфейс для работы с данными.

### Основные возможности

- **Парсинг объявлений** — автоматический сбор данных о недвижимости с Cian.ru (цена, площадь, этаж, метро, адрес и др.)
- **Группировка по объектам** — автоматическое определение, что несколько объявлений относятся к одному объекту недвижимости
- **Полный парсинг** — возможность дозагрузить полную информацию с детальной страницы объявления
- **ML-оценка вероятности продажи** — алгоритм оценки ликвидности объявления на основе его характеристик
- **Отслеживание статусов** — логирование публикации/снятия объявлений
- **Веб-админка** — удобный интерфейс для управления и просмотра данных
- **Фильтрация и сортировка** — гибкий поиск по городу, типу сделки, цене, комнатам, площади с сортировкой

## Технологии

- **Backend**: Python 3.11, FastAPI
- **Database**: PostgreSQL 15
- **Frontend**: Bootstrap 5, Jinja2 Templates
- **Infrastructure**: Docker, Docker Compose

## Структура базы данных

### Properties (Объекты недвижимости)
- Уникальный объект недвижимости (квартира, дом)
- Группирует все объявления об одном объекте
- Идентификация по хешу: город + улица + дом + этаж + площадь + комнаты

### Listings (Объявления)
- Результат парсинга с Avito
- Содержит все характеристики объявления
- Связан с объектом недвижимости (property_id)

### StatusLogs (Логи статусов)
- История изменений статуса объявления
- Отслеживает публикацию, снятие, повторную публикацию

## Быстрый старт

### Требования
- Docker 20.10+
- Docker Compose 2.0+

### Установка и запуск

1. **Клонируйте репозиторий:**
```bash
git clone <repo-url>
cd listing-rater
```

2. **Запустите приложение:**
```bash
docker-compose up -d
```

3. **Примените миграции базы данных:**
```bash
# Если база данных уже существовала, сначала отметьте текущую миграцию
docker-compose exec app alembic stamp head

# Примените все миграции
docker-compose exec app alembic upgrade head
```

4. **Откройте приложение в браузере:**
```
http://localhost:8000
```

### Первый запуск

При первом запуске приложение автоматически создаст все необходимые таблицы в базе данных. Если вы используете существующую базу данных, убедитесь, что применили все миграции.

### Остановка

```bash
# Остановить контейнеры
docker-compose down

# Остановить и удалить volumes (удалит все данные!)
docker-compose down -v
```

## Использование

### Парсинг объявлений

1. Перейдите на страницу **Парсинг** (`/parser`)
2. Выберите параметры:
   - **Город** (Санкт-Петербург, Москва и др.)
   - **Тип недвижимости** (Квартиры, Комнаты, Дома и др.)
   - **Тип сделки** (Продажа, Аренда)
   - **Количество страниц** для парсинга
3. Нажмите **Запустить парсинг**
4. Дождитесь завершения (можно отслеживать статус)

### Работа с объявлениями

- **Список объявлений** (`/listings`) — просмотр всех объявлений с фильтрацией
- **Детали объявления** (`/listings/{id}`):
  - Просмотр полной информации
  - Кнопка **"Спарсить полностью"** — дозагружает данные с детальной страницы Cian
  - Кнопка **"Вычислить вероятность продажи"** — ML-оценка ликвидности (доступна после полного парсинга)
  - Редактирование данных вручную

### Работа с объектами недвижимости

- **Список объектов** (`/properties`) — просмотр сгруппированных объектов
- Фильтрация по городу, типу, цене, площади
- Сортировка по цене (возрастание/убывание) или дате создания
- **Детали объекта** (`/properties/{id}`) — просмотр всех объявлений по одному объекту


## Конфигурация

Переменные окружения (можно задать в `.env` файле):

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/listing_rater
```

## ML-оценка вероятности продажи

Система включает алгоритм оценки вероятности продажи объявления (0-100%). Оценка основана на следующих факторах:

- **Цена за м²** — чем ниже относительно среднего, тем выше вероятность
- **Метро** — наличие и близость к метро
- **Этаж** — оптимальны средние этажи (30-70% от высоты дома)
- **Площадь** — оптимальный диапазон 30-80 м²
- **Количество комнат** — популярные варианты (1, 2, 3 комнаты)
- **Полнота данных** — чем больше заполнено полей, тем выше оценка

Для использования функции:
1. Откройте детальную страницу объявления
2. Нажмите **"Спарсить полностью"** (если еще не делали)
3. Нажмите **"Вычислить вероятность продажи"**
4. Система покажет оценку с объяснением факторов
